<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>我的 OJ 平台</title>
        <meta name="description" content="Charcoal is a free Bootstrap 4 UI kit build by @attacomsian at Wired Dots." />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!--Bootstrap 4-->
        <link rel="stylesheet" href="css/bootstrap.min.css">
        <script src="js/jquery.min.js"></script>
    </head>
    <body>

        <nav class="navbar navbar-expand-md navbar-dark fixed-top sticky-navigation">
            <a class="navbar-brand font-weight-bold" href="#">我的 OJ 系统</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#topMenu" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="topMenu">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item active">
                        <a class="nav-link page-scroll" href="problem_list.html">主页<span class="sr-only">(current)</span></a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link page-scroll" href="javascript:logout()" >注销<span class="sr-only">(current)</span></a>
                    </li>
                </ul>
            </div>
        </nav>

        <!--hero section-->
        <section class="bg-hero">
            <div class="container">
                <div class="row vh-100">
                    <div class="col-sm-12 my-auto text-center">
                        <h1>我的 OJ 平台</h1>
                        <p class="lead text-capitalize my-4">
                            基于 SSM 实现的 OJ 系统
                        </p>
                        <a href="https://github.com/taonottao/projectStudy/tree/main/java_oj" class="btn btn-outline-light btn-radius btn-lg" target="_blank">项目链接</a>
                    </div>
                </div>
            </div>
        </section>

        <!--components-->
        <section class="my-5 pt-5">
            <div class="container">
                <div class="row mt-4">
                    <div class="col-sm-12 pb-4">
                        <div class="jumbotron jumbotron-fluid">
                            <div class="container" id="problemDesc">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-sm-12 pb-4">
                        <div class="form-group">
                            <label for="codeEditor">代码编辑框</label>
                            <div id="editor" style="min-height: 400px">
                                <textarea class="form-control" id="codeEditor" style="width: 100%; height: 400px;"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="tool">
                    <button type="button" class="btn btn-primary" id="submitButton" onclick="compileRun()">提交</button>
<!--                    &nbsp;&nbsp;&nbsp;&nbsp;-->
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <!--                    <button type="button" class="btn btn-primary" id="" onclick="praise()">点赞</button>&nbsp;&nbsp;&nbsp;&nbsp;-->
                    <a href="javascript:praise()">
                        <svg id="praise" t="1691997776648" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2342" width="20" height="20">
                            <path d="M518.4 149.290667c112.597333-80.789333 267.882667-69.397333 368.128 32 53.866667 54.528 84.138667 128.853333 84.138667 206.378666 0 77.525333-30.293333 151.850667-84.096 206.336l-294.421334 299.52a110.976 110.976 0 0 1-80.213333 34.474667 110.72 110.72 0 0 1-79.914667-34.176L137.322667 593.770667C83.562667 539.242667 53.333333 464.981333 53.333333 387.541333s30.229333-151.722667 84.010667-206.272c100.224-101.376 255.530667-112.768 368.128-31.978666l6.442667 4.778666 6.485333-4.778666z m322.602667 76.970666c-84.629333-85.589333-219.157333-88.64-307.328-6.954666l-21.76 20.138666-21.717334-20.138666c-88.192-81.685333-222.72-78.634667-307.306666 6.933333-41.92 42.496-65.557333 100.608-65.557334 161.28 0 60.693333 23.637333 118.805333 65.6 161.344l295.04 300.416c9.045333 9.450667 21.269333 14.72 33.962667 14.72 12.693333 0 24.917333-5.269333 34.261333-15.04L840.96 549.077333c42.005333-42.496 65.685333-100.650667 65.685333-161.408 0-60.736-23.68-118.912-65.664-161.408z" fill="#707070" p-id="2343"></path>
                        </svg>
                    </a>
                    &nbsp;&nbsp;&nbsp;&nbsp;
                    <span id="likeCount"></span>
                </div>
                <div class="row mt-4">
                    <div class="col-sm-12 pb-4">
                        <div class="jumbotron jumbotron-fluid">
                            <div class="container" >
                                <pre id="problemResult">

                                </pre>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-sm-12 pb-4">
                        <div class="form-group">
                            <div class="form-group">
<!--                                <label for="description">回复</label>-->
                                <textarea class="form-control" id="commentContent" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-primary" id="comment" onclick="comment()">评论</button>
            </div>

        </section>
        <section class="my-5 pt-5">
            <div class="container">

                <div class="row mb-5" id="tables">
                    <div class="col-sm-12">
                        <div class="mt-3 mb-5">
                            <h3>评论区</h3>
                            <table class="table table-striped">
                                <tbody id="comments">
<!--                                    <span>111</span><br>-->
<!--                                    <span>222</span>-->
                                </tbody>
                            </table>
                        </div>

                    </div>
                </div>


            </div>
        </section>


        <!--footer-->
        <section class="py-5 bg-dark">
            <div class="container">
                <div class="row">
                    <div class="col-md-6 offset-md-3 col-sm-8 offset-sm-2 col-xs-12 text-center">
                        <p class="pt-2 text-muted">
                            &copy;by 王同学
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js"></script>
        <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/css/bootstrap-grid.css"></script>
        <script src="js/app.js"></script>

<!--        引入 ace.js -->
        <script src="https://cdn.bootcdn.net/ajax/libs/ace/1.2.9/ace.js"></script>
        <script src="https://cdn.bootcdn.net/ajax/libs/ace/1.2.9/ext-language_tools.js"></script>

        <script type="text/javascript">




            function initAce(){
                // 参数 editor 就对应刚才在 HTML 里加的那个 div 的 id
                let editor = ace.edit("editor");
                editor.setOptions({
                    enableBasicAutocompletion: true,
                    enableSnippets: true,
                    enableLiveAutocompletion: true
                });
                editor.setTheme("ace/theme/twilight");
                editor.session.setMode("ace/mode/java");
                editor.resize();
                document.getElementById('editor').style.fontSize = '20px';

                return editor;
            }
            let editor = initAce();

            let problem;
            // 通过 ajax 从服务器获取到题目的详情
            function getProblem(id){
                if (id == "") {
                    alert("非法参数");
                    return;
                }
                // 1. 通过 ajax 给服务器发送一个请求
                $.ajax({
                    url:"/problem/selectone",
                    type:"POST",
                    data:{"id":id},
                    success: function (result) {
                        if (result != null && result.code == 200) {
                            problem = result.data;
                            makeProblemDetail(result);
                            document.querySelector("#likeCount").innerHTML=result.data.likeCount;
                        }else{
                            alert("参数错误！")
                            location.href="problem_list.html";
                        }
                    }
                });

            }

            function getUrlValue(key) {
                // ?id=3&m=6
                let params = location.search;
                if (params.length > 1) {
                    params = params.substring(1);
                    let paramsArr = params.split("&");
                    for(let i = 0; i < paramsArr.length; i++){
                        let kv = paramsArr[i].split("=");
                        if(kv[0] == key){
                            return kv[1];
                        }
                    }
                }
                return "";
            }
            let id = getUrlValue("id")
            getProblem(id);



            function makeProblemDetail(result) {
                // 1. 获取到 problemDesc，把题目详情写进去
                let problemDesc = document.querySelector("#problemDesc");
                let h3 = document.createElement("h3");
                h3.innerHTML = result.data.id + "." + result.data.title + "_" + result.data.level;
                problemDesc.appendChild(h3);

                let pre = document.createElement("pre");
                let p = document.createElement("p");
                p.innerHTML = result.data.description;
                pre.appendChild(p);
                problemDesc.appendChild(pre);

                // 2. 把代码的模板填写到编辑框中
                editor.setValue(result.data.templateCode);

            }
            function compileRun(){
                $.ajax({
                    url: "/problem/compile-run",
                    type: "POST",
                    data: JSON.stringify({"id":id,"templateCode":editor.getValue()}),
                    // data: {"id":id,"templateCode":editor.getValue()},
                    success: function (result) {
                        let problemResult = document.querySelector("#problemResult");
                        if (result.data.error == 0) {
                            // 编译运行没有问题, 把 stdout 显示到页面中
                            problemResult.innerHTML = result.data.stdout;
                        }else {
                            // 编译运行有问题, 把 reason 显示到页面中
                            problemResult.innerHTML = result.data.reason;
                        }
                    }
                })
            }
            function logout(){
                // alert("0000");
                if(confirm("确认是否注销？")){
                    $.ajax({
                        url: "/user/logout",
                        type: "GET",
                        success: function (result) {
                            if(result != null && result.code == 200){
                                location.href="login.html";
                            }
                        },
                    })
                }
            }
            function praise(){
                // alert("111");
                $.ajax({
                    url: "/problem/praise",
                    type: "POST",
                    data: {"id": id},
                    success: function (result) {
                        if (result != null && result.code == 200) {
                            document.querySelector("#likeCount").innerHTML=result.data;
                        }
                    },
                })
            }

            function comment() {
                // alert("12456");
                let commentContent = $("#commentContent");
                if (commentContent.val().trim() == "") {
                    alert("内容不能为空！");
                    commentContent.focus();
                    return;
                }
                jQuery.ajax({
                    url: "/comment/add",
                    type: "POST",
                    data: {"pid":id, "content":commentContent.val()},
                    success: function (result) {
                        if (result != null && result.code == 200) {
                            document.getElementById('comment').value = "";
                            commentList();
                        } else {
                            alert("评论失败，请重试！");
                        }
                    },
                })
            }

            function commentList() {
                jQuery.ajax({
                    url: "/comment/getlist",
                    type: "POST",
                    data: {"pid":id},
                    success: function (result) {
                        if (result != null && result.code == 200) {
                            let comments = document.querySelector("#comments");
                            comments.innerHTML="";
                            for (let i = 0; i < result.data.length; i++) {
                                let comment = result.data[i];
                                let spanUser = document.createElement("span");
                                spanUser.innerHTML = comment.username + ": ";
                                comments.appendChild(spanUser);
                                let br1 = document.createElement("br");
                                comments.appendChild(br1);
                                let spanContent = document.createElement("span");
                                spanContent.innerHTML="&nbsp;&nbsp;&nbsp;"+comment.content;
                                comments.appendChild(spanContent);
                                let br2 = document.createElement("br");
                                comments.appendChild(br2);
                            }
                        }

                    },
                })
            }
            commentList();
        </script>
    </body>
</html>
